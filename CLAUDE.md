# Development Partnership

We're building production-quality code together. Your role is to create maintainable, efficient solutions while catching
potential issues early.

When you seem stuck or overly complex, I'll redirect you as my guidance helps you stay on track.

## ðŸš¨ AUTOMATED CHECKS ARE MANDATORY

**ALL issues are BLOCKING - EVERYTHING must be âœ… GREEN!**
No errors. No formatting issues. No linting problems. Zero tolerance.
These are not suggestions. Fix ALL issues before continuing.

## CRITICAL WORKFLOW - ALWAYS FOLLOW THIS!

### Research â†’ Plan â†’ Implement

**NEVER JUMP STRAIGHT TO CODING!** Always follow this sequence:

1. **Research**: Explore the codebase, understand existing patterns
2. **Plan**: Create a detailed implementation plan and verify it with me
3. **Implement**: Execute the plan with validation checkpoints

When asked to implement any feature, you'll first say: "Let me research the codebase and create a plan before
implementing."

For complex architectural decisions or challenging problems, use **"ultra think"** to engage maximum reasoning capacity.
Say: "Let me ultra think about this architecture before proposing a solution."

### Required Standards:

- **No manual environment variable loading**: Use the `runTest` wrapper which automatically loads `.env` variables
- Delete old code when replacing it
- Early returns to reduce nesting
- Database table-driven tests for complex logic
- When investigating MySQL issues, always run SQL commands by executing it with a js file, not with a raw bash command
- **Before completing any task**: Review all newly written functions and remove unused imports and unused function parameters that are defined but never referenced in the function body. **CRITICAL**: When removing unused parameters, update BOTH the function definition AND all call sites - ensure the number of arguments passed matches the number of parameters received

### USE MULTIPLE AGENTS!

_Leverage subagents aggressively_ for better results:

- Spawn agents to explore different parts of the codebase in parallel
- Use one agent to write tests while another implements features
- Delegate research tasks: "I'll have an agent investigate the database schema while I analyze the API structure"
- For complex refactoring: One agent identifies changes, another implements them

Say: "I'll spawn agents to tackle different aspects of this problem" whenever a task has multiple independent parts.

### Reality Checkpoints

**Stop and validate** at these moments:

- After implementing a complete feature
- Before starting a new major component
- When something feels wrong
- Before declaring "done"

Your code must be 100% clean. No exceptions.

**Recovery Protocol:**

- When interrupted by a failure, maintain awareness of your original task
- After fixing all issues and verifying the fix, continue where you left off
- Use the todo list to track both the fix and your original task

## Working Memory Management

### When context gets long:

- Re-read this CLAUDE.md file
- Summarize progress in a PROGRESS.md file
- Document current state before major changes

### Maintain TODO.md:

```
## Current Task
- [ ] What we're doing RIGHT NOW

## Completed
- [x] What's actually done and tested

## Next Steps
- [ ] What comes next
```

## Problem-Solving Together

When you're stuck or confused:

1. **Stop** - Don't spiral into complex solutions
2. **Delegate** - Consider spawning agents for parallel investigation
3. **Ultrathink** - For complex problems, say "I need to ultrathink through this challenge" to engage deeper reasoning
4. **Step back** - Re-read the requirements
5. **Simplify** - The simple solution is usually correct
6. **Ask** - "I see two approaches: [A] vs [B]. Which do you prefer?"

My insights on better approaches are valued - please ask for them!

## CRITICAL FILE GENERATION RULES

**ALL FILES GENERATED BY CLAUDE MUST BE PLACED IN THE `.claude/` DIRECTORY**

1. **Test Files Location**:
   - MUST be created in `.claude/test-{feature-name}/` directories
   - Example: `.claude/test-stock-analysis/test-ai-prediction.js`
   - NEVER create test files in root directories like `/scripts`, `/migrations`, `/test-files`, etc.

2. **Temporary Files/Scripts**:
   - Any temporary scripts, migrations, or utility files MUST go in `.claude/temp/`
   - Example: `.claude/temp/data-migration-script.js`

3. **Log Files**:
   - All logs MUST be written to `.claude/logs/`
   - Create a log entry for every file created or modified

4. **File Organization**:
   ```
   .claude/
   â”œâ”€â”€ test-{feature-name}/     # Feature-specific test directories
   â”‚   â””â”€â”€ test-{specific}.js   # Individual test files
   â”œâ”€â”€ temp/                    # Temporary scripts and utilities
   â”œâ”€â”€ logs/                    # Activity logs
   â””â”€â”€ screenshots/             # UI screenshots if needed
   ```

### Test File Guidelines

When creating test files:

- Always use the `runTest(async () => {})` wrapper from `test/bootstrap.js`
- Use database connection helpers from `lib/mysql/mysql.mjs`
- Environment variables are loaded automatically via the wrapper â€” do NOT manually load dotenv
- Do NOT manually call `process.exit()` - the wrapper handles this
- Clean up test data after completion
- Query relevant tables to confirm structure before proceeding

### Example Test File Structure

```javascript
// File: .claude/test-stock-analysis/test-ai-prediction.js
import {runTest} from '../../test/bootstrap.js';
import {getStocksDB} from '../../lib/mysql/mysql.mjs';

runTest(async () => {
	const db = getStocksDB();
	try {
		// Your test code here
		const stocksTable = db.getTable('stocks');
		const result = await stocksTable.select({symbol: 'AAPL'});
		console.log('Test result:', result);
	} catch (err) {
		console.error('Test failed:', err);
		throw err;
	}
});
```

---

## Environment & Configuration

- Port: `3000` (dev)
- Node.js: v16.14.0+ / v17.9.0+ / v18.0.0+
- `.env` handles all environment configuration
- Database config files: `lib/mysql`
- Database: `stocks` (dedicated schema created by setup script)

---

## Running Tests

```bash
# âœ… Run Claude-generated test files
node .claude/test-stock-analysis/test-ai-prediction.js

# âœ… Run existing test files
node test/stocks/test-stock-analysis.js
```

---

## Project Structure

```
/lib/ai              # AI provider integrations (OpenAI, Gemini, Anthropic)
  /apis/base         # Provider factory and interface
  /apis/openai       # OpenAI provider
  /apis/gemini       # Google Gemini provider
  /apis/anthropic    # Anthropic Claude provider
/lib/stocks          # Stock business logic
/lib/mysql           # Database layer (connector, table, query builder)
/lib/common          # Utility functions (array, date, string, number)
/app                 # Next.js App Router pages
  /api               # API routes
/components          # React components
  /ui                # shadcn/ui components only
/database            # SQL schema files
/test                # Test files and bootstrap
```

---

## Code Standards

### JavaScript/TypeScript

- Use `const` arrow functions
- Prefer destructuring, optional chaining (`?.`), and nullish coalescing (`??`)
- Match existing JS/TS file type when modifying
- Use ES modules (`.mjs` for pure JS, `.jsx` for React)

### React

- Functional components only
- Use `useState`, `useEffect`, `useCallback`, `useMemo` as needed
- No ReactIcons library â€” use custom SVGs or Lucide icons

### UI Component Standards - shadcn/ui

**MANDATORY: All React JSX interfaces MUST use shadcn/ui components exclusively**

#### Component Usage Rules:

- **ALWAYS** use shadcn/ui components for ALL UI elements
- **NEVER** create custom styled divs/buttons when a shadcn component exists
- Follow the exact patterns from shadcn/ui documentation examples

#### Import Pattern:

```jsx
import {Button} from '@/components/ui/button';
import {
	Card,
	CardContent,
	CardDescription,
	CardFooter,
	CardHeader,
	CardTitle
} from '@/components/ui/card';
import {Input} from '@/components/ui/input';
import {Label} from '@/components/ui/label';
import {
	Select,
	SelectContent,
	SelectItem,
	SelectTrigger,
	SelectValue
} from '@/components/ui/select';
```

#### Styling Requirements:

- Use exact className patterns and variants from shadcn examples
- Maintain default shadcn color scheme (slate/zinc neutrals with primary accents)
- Apply consistent spacing using shadcn's standard classes
- Use default border-radius values (rounded-md, rounded-lg)

#### Component Composition Patterns:

```jsx
// Cards - use full composition structure
<Card>
	<CardHeader>
		<CardTitle>Title</CardTitle>
		<CardDescription>Description</CardDescription>
	</CardHeader>
	<CardContent>Content</CardContent>
	<CardFooter>Footer</CardFooter>
</Card>

// Forms - use Form component structure
<Form>
	<FormField>
		<FormItem>
			<FormLabel>Label</FormLabel>
			<FormControl>
				<Input />
			</FormControl>
			<FormDescription>Help text</FormDescription>
			<FormMessage />
		</FormItem>
	</FormField>
</Form>
```

#### Color Tokens (use these exclusively):

- Background: `bg-background`, `bg-card`
- Foreground: `text-foreground`, `text-muted-foreground`
- Borders: `border`, `border-input`
- Primary: `bg-primary`, `text-primary-foreground`
- Secondary: `bg-secondary`, `text-secondary-foreground`
- Destructive: `bg-destructive`, `text-destructive-foreground`

#### PROHIBITED:

- âŒ Custom CSS classes
- âŒ Overriding shadcn default styling
- âŒ Inline styles
- âŒ Mixing other UI libraries with shadcn
- âŒ Custom color values outside shadcn tokens

Every component should look **exactly** like shadcn/ui documentation examples.

### Formatting

**CRITICAL**: Use tabs for indentation with tabWidth 3, single quotes.

```js
const handleSubmit = async (data) => {
	try {
		const result = await api.post('/endpoint', data);
		return result;
	} catch (err) {
		console.error('Error:', err);
		throw err;
	}
};
```

Run `npm run format` before committing to ensure consistent formatting across all files.

---

## Database Standards

### Database Structure

- Database: `stocks` (dedicated schema for this project)
- Tables: `stocks`, `stock_prices`, `stock_analysis`, `stock_predictions`, `watchlist`, `stock_news`
- Schema file: `database/stocks_schema_clean.sql`
- Setup script: Run `node .claude/test-setup-stocks-schema/create-stocks-schema.mjs` to create the database and tables

### Query Patterns

- Use parameterized queries
- Use transactions for multi-table changes
- Review table schema before querying
- Use `MysqlTable` class for common CRUD operations
- Use query builder from `lib/mysql/query-builder.mjs` for complex queries

```js
export const getStockBySymbol = async (symbol) => {
	const db = getStocksDB();
	const stocksTable = db.getTable('stocks');
	const result = await stocksTable.selectOne({symbol});
	return result;
};

export const saveStockAnalysis = async (analysisData) => {
	const db = getStocksDB();
	const analysisTable = db.getTable('stock_analysis');
	return await analysisTable.insert(analysisData);
};
```

---

## AI Provider Integration

### AI Provider Factory Pattern

All AI interactions MUST use the unified factory from `lib/ai/apis/ai-responses.mjs`:

```js
import {submitToAIProvider, switchAIProvider} from '@lib/ai/apis/ai-responses.mjs';

// Submit to current provider
const response = await submitToAIProvider({
	messages: [{role: 'user', content: 'Analyze AAPL stock'}],
	temperature: 0.7,
	max_tokens: 1000
});

// Submit to specific provider
const geminiResponse = await submitToAIProvider({
	provider: 'gemini',
	messages: [{role: 'user', content: 'Analyze AAPL stock'}]
});
```

### Available Providers

- **OpenAI**: `gpt-4o`, `gpt-4o-mini`, `o1`, `o3-mini`
- **Gemini**: `gemini-2.0-flash-exp`, `gemini-1.5-pro`
- **Anthropic**: `claude-3-5-sonnet-20241022`, `claude-3-5-haiku-20241022`

### Provider Configuration

- Environment variables: `OPENAI_API_KEY`, `GEMINI_API_KEY`, `ANTHROPIC_API_KEY`
- Default provider: Set in `.env` as `DEFAULT_AI_PROVIDER`
- Provider configs: `lib/ai/apis/{provider}/{provider}-config.mjs`

### AI Response Storage

When storing AI analysis results:

```js
const analysisData = {
	stock_id: stockId,
	analysis_type: 'ai_prediction', // fundamental, technical, sentiment, ai_prediction, custom
	ai_provider: 'openai', // openai, gemini, anthropic
	ai_model: 'gpt-4o',
	analysis_data: {
		/* JSON data */
	},
	confidence_score: 0.85,
	created_at: getNowForSQL()
};

await saveStockAnalysis(analysisData);
```

---

## API Pattern

```js
export default async function handler(req, res) {
	const handlerMap = {
		POST: handlePost,
		GET: handleGet
	};
	return methodHandler(req, res, handlerMap);
}

async function handlePost(req, res) {
	const session = await getServerSession(req, res, authOptions(req, res));

	const {symbol, analysis_type} = req.body;

	const result = await analyzeStock(symbol, analysis_type);

	if (result) {
		return {success: true, data: result};
	} else {
		return {success: false, error: 'Analysis failed'};
	}
}
```

---

## Stock Analysis Workflow

### Typical Analysis Flow:

1. **Fetch Stock Data**: Get current stock info from database or external API
2. **Submit to AI**: Use `submitToAIProvider()` with structured prompts
3. **Parse Response**: Extract insights, predictions, confidence scores
4. **Store Results**: Save to `stock_analysis` table with proper metadata
5. **Update Stock Status**: Update `stocks` table status if needed

### Example Implementation:

```js
export const analyzeStockWithAI = async (symbol, analysisType = 'ai_prediction') => {
	// 1. Fetch stock data
	const stock = await getStockBySymbol(symbol);
	if (!stock) throw new Error('Stock not found');

	// 2. Build AI prompt
	const prompt = `Analyze ${symbol} (${stock.name}) for ${analysisType}.
	Provide: insights, risk_level, confidence_score, recommendation.`;

	// 3. Submit to AI
	const aiResponse = await submitToAIProvider({
		messages: [{role: 'user', content: prompt}],
		temperature: 0.3,
		max_tokens: 1500
	});

	// 4. Parse and store
	const analysisData = {
		stock_id: stock.id,
		analysis_type: analysisType,
		ai_provider: aiResponse.provider,
		ai_model: aiResponse.model,
		analysis_data: JSON.parse(aiResponse.content),
		created_at: getNowForSQL()
	};

	await saveStockAnalysis(analysisData);

	return analysisData;
};
```

---

## Communication Protocol

### Progress Updates:

```
âœ“ Implemented stock analysis with OpenAI (all tests passing)
âœ“ Added Gemini provider integration
âœ— Found issue with stock price fetching - investigating
```

### Suggesting Improvements:

"The current approach works, but I notice [observation].
Would you like me to [specific improvement]?"

---

## Working Together

- This is always a feature branch - no backwards compatibility needed
- When in doubt, we choose clarity over cleverness
- **REMINDER**: If this file hasn't been referenced in 30+ minutes, RE-READ IT!

Avoid complex abstractions or "clever" code. The simple, obvious solution is probably better, and my guidance helps you
stay focused on what matters.

---

## IMPORTANT: Things to NEVER Update

**NEVER UPDATE OR MODIFY THE FOLLOWING:**

1. **AI Model Names**: Model names in configuration files are intentional and valid. Do NOT change them even if they seem unfamiliar.
2. **API Keys and Credentials**: Never modify existing API keys or credentials in configuration files.
3. **Database Connection Strings**: Do not alter existing database configurations unless explicitly instructed.
4. **Provider Configurations**: Leave all AI provider configurations as-is unless specifically requested.
5. **Environment Variables**: Do not modify `.env` values unless explicitly told to do so.
